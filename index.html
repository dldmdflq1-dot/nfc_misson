<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>NFC ë¯¸ì…˜ ë¦´ë ˆì´ v2.4</title>
  <style>
    :root{
      --bg:#fff8fb; --text:#1e1c2a; --sub:#6b6b87; --line:#e9e2ef;
      --p1:#ffd7e8; --p2:#c8f7ff; --p3:#d8ffd6; --p4:#fff2c6; --ok:#25c27a; --bad:#ff5577; --warn:#ffb347;
      --btn:#1e1c2a; --card:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{background:var(--bg)}
    body{margin:0; color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Apple SD Gothic Neo, Noto Sans KR, sans-serif;}

    /* ê²Œì„ í™”ë©´ */
    .screen{height:100svh; display:grid; grid-template-rows: 56px 1fr 120px; gap:8px; padding:12px; overflow:hidden}
    .hidden{display:none !important}

    .status{display:flex; align-items:center; justify-content:space-between; gap:10px; background:var(--card); border:1px solid var(--line); border-radius:14px; padding:8px 12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .status .left{display:flex; gap:8px; align-items:center; min-width:0}
    .status .right{display:flex; gap:6px; align-items:center}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(90deg,var(--p2),var(--p3)); font-weight:700}

    .main{display:grid; place-items:center; background:var(--card); border:1px solid var(--line); border-radius:18px; overflow:hidden; padding:12px}
    .big{width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px}
    .big-btn{appearance:none; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; width:min(88vw,420px); height:min(40vh,260px);
      border-radius:22px; background:linear-gradient(135deg,var(--p1),var(--p2)); color:var(--btn); font-weight:900; font-size:20px; box-shadow:0 8px 0 rgba(0,0,0,0.06);
      border:2px solid var(--line); overflow:hidden
    }
    .big-btn.hasimg{padding:0}
    .big-btn img{width:100%; height:100%; object-fit:cover}

    .code-area{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; width:100%}
    .code-area input{width:min(88vw,420px); height:56px; border-radius:14px; border:2px solid var(--line); padding:0 14px; font-size:18px; background:#fff; color:var(--text)}
    .code-btn{appearance:none; border:none; cursor:pointer; width:min(88vw,420px); height:56px; border-radius:14px; background:linear-gradient(135deg,var(--p2),var(--p3)); border:2px solid var(--line); font-weight:900; font-size:18px}

    .foot{background:var(--card); border:1px solid var(--line); border-radius:18px; padding:10px 12px; display:grid; grid-template-columns:1fr; gap:8px}
    .msg{font-size:15px}
    .msg.ok{color:var(--ok)} .msg.bad{color:var(--bad)} .msg.warn{color:var(--warn)}

    /* íŒíŠ¸ ë²„íŠ¼ */
    .hint-btn{appearance:none; border:none; cursor:pointer; font-size:15px; font-weight:700; 
      background:linear-gradient(90deg,rgba(255,215,232,.5),rgba(200,247,255,.5));
      padding:10px 12px; border-radius:12px; border:1px solid var(--line)}
    .hint-btn:disabled{opacity:.6; cursor:not-allowed}

    /* ì œì‘ í™”ë©´ */
    .admin{position:fixed; inset:10px; background:#ffffff; border:2px solid var(--line); border-radius:16px; padding:12px; max-height:calc(100svh - 20px); overflow:auto; box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .admin h3{margin:6px 0 10px}
    .grid{display:grid; gap:10px}
    .two{grid-template-columns:1fr 1fr}
    @media (max-width:960px){.two{grid-template-columns:1fr}}
    label{font-size:12px; color:var(--sub)}
    input,select,textarea{width:100%; padding:10px 12px; border-radius:12px; border:1.5px solid var(--line); background:#fff}
    button.small{padding:8px 10px; border-radius:10px; border:1.5px solid var(--line); background:#fff; cursor:pointer}
    .urls{display:flex; flex-wrap:wrap; gap:6px}
    .urltag{font-size:12px; padding:6px 8px; border-radius:10px; border:1px solid var(--line); background:#fafafa; cursor:pointer}

    /* ì„¸ê·¸ë¨¼íŠ¸ ë°•ìŠ¤ */
    .seg{display:flex; border:1.5px solid var(--line); border-radius:12px; overflow:hidden; width:fit-content}
    .seg button{appearance:none; border:none; background:#fff; padding:8px 12px; cursor:pointer; font-weight:700}
    .seg button.active{background:linear-gradient(135deg,var(--p2),var(--p3));}

    /* í•¨ì • ë¦¬ìŠ¤íŠ¸ */
    .trapRow{display:grid; grid-template-columns:1fr 120px 1.7fr 80px; gap:8px; align-items:end}
    @media (max-width:1200px){ .trapRow{grid-template-columns:1fr 1fr;}}

    /* íŒ€ ì„¤ì •: ê°€ë¡œ ìŠ¤í¬ë¡¤ ì»¬ëŸ¼ */
    .teamColsWrap{overflow-x:auto; padding-bottom:6px}
    .teamCols{display:grid; grid-auto-flow:column; grid-auto-columns: 420px; gap:12px; align-items:start}
    .teamCard{border:1.5px solid var(--line); border-radius:12px; padding:10px; background:#fff; min-width:420px}
    .stageRowX4{display:grid; grid-template-columns:repeat(4,1fr); gap:8px}
    .stageRow5{display:grid; grid-template-columns:64px 1fr 1fr 1fr 2fr; gap:8px}
    .stageHeader{display:grid; grid-template-columns:64px 1fr 1fr 1fr 2fr; gap:8px; font-size:12px; color:var(--sub); margin-bottom:4px; border-bottom:1px dashed var(--line); padding-bottom:4px}
    .stageBadge{display:flex; align-items:center; justify-content:center; height:38px; border:1.5px solid var(--line); border-radius:10px; background:#fafafa; font-weight:700}
    @media (max-width:1400px){ .stageRowX4{grid-template-columns:1fr 1fr} }

    /* ê³µìš© ëª¨ë‹¬ */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:center; justify-content:center; z-index:50}
    .modal.hidden{display:none}
    .modal-inner{background:#fff; border-radius:16px; border:2px solid var(--line); width:min(92vw,520px); padding:16px; text-align:center; box-shadow:0 12px 30px rgba(0,0,0,.2); animation:pop .2s ease}
    .modal-inner img{max-width:100%; height:auto; border-radius:12px; border:1px solid var(--line)}
    .modal-inner h3{margin:8px 0 10px}
    @keyframes pop{from{transform:scale(.95); opacity:0} to{transform:scale(1); opacity:1}}

    /* ê²°ê³¼ ëª¨ë‹¬ ìƒ‰ìƒ */
    .modal-inner.success{border-color:#b7f5c9; box-shadow:0 12px 30px rgba(37,194,122,.25)}
    .modal-inner.fail{border-color:#ffb6c3; box-shadow:0 12px 30px rgba(255,85,119,.25)}
  </style>
</head>
<body>
  <!-- ê²Œì„ í™”ë©´: team íŒŒë¼ë¯¸í„° ìˆì„ ë•Œë§Œ í‘œì‹œ -->
  <div class="screen hidden" id="gameScreen">
    <div class="status">
      <div class="left">
        <span id="title">ğŸ“ NFC ë¯¸ì…˜</span>
        <span class="chip" id="teamChip">TEAM</span>
      </div>
      <div class="right" id="statusLine">ì§„í–‰ 0/0 | â—‹â—‹â—‹â—‹â—‹</div>
    </div>

    <div class="main">
      <div class="big" id="stageArea">
        <button id="btnScan" class="big-btn">ìŠ¤ìº” ì‹œì‘</button>
      </div>
    </div>

    <div class="foot">
      <div class="msg" id="msg">ì¤€ë¹„ ì™„ë£Œ. ìŠ¤í‹°ì»¤ë¥¼ íƒœê·¸í•˜ì„¸ìš”.</div>
      <button id="btnHint" class="hint-btn" disabled>íŒíŠ¸ ë³´ê¸°</button>
    </div>
  </div>

  <!-- ì™„ë£Œ íŒì—…(ê¸°ì¡´ ìœ ì§€) -->
  <div class="modal hidden" id="completeModal">
    <div class="modal-inner">
      <h3>ëª¨ë“  ë¯¸ì…˜ ì™„ë£Œ!</h3>
      <img id="completeImg" alt="complete" src=""/>
      <div style="margin-top:10px"><button class="small" id="btnCloseModal">ë‹«ê¸°</button></div>
    </div>
  </div>

  <!-- íŒíŠ¸ íŒì—… -->
  <div class="modal hidden" id="hintModal">
    <div class="modal-inner">
      <h3>íŒíŠ¸</h3>
      <img id="hintImg" alt="hint" src="" style="display:none"/>
      <div id="hintText" style="margin-top:8px; font-size:15px"></div>
      <div style="margin-top:10px"><button class="small" id="btnCloseHint">ë‹«ê¸°</button></div>
    </div>
  </div>

  <!-- ì½”ë“œ ê²°ê³¼ íŒì—… -->
  <div class="modal hidden" id="resultModal">
    <div class="modal-inner" id="resultInner">
      <div id="resultIcon" style="font-size:56px">âœ…</div>
      <h3 id="resultTitle">ì •ë‹µ!</h3>
      <div id="resultMsg" style="font-size:15px">ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•˜ì„¸ìš”.</div>
      <div style="margin-top:10px"><button class="small" id="btnCloseResult">í™•ì¸</button></div>
    </div>
  </div>

  <!-- ì œì‘ í™”ë©´ -->
  <div class="admin" id="admin">
    <h3>ì œì‘í™”ë©´ Â· ê´€ë¦¬ì</h3>

    <div class="grid two" style="margin-top:6px">
      <div>
        <label>ì œëª©</label>
        <input id="cfgTitle" placeholder="NFC ë¯¸ì…˜" />
      </div>
      <div>
        <label>ë‹¨ê³„ ìˆ˜</label>
        <input id="cfgStages" type="number" min="1" max="20" value="5" />
      </div>
    </div>

    <div class="grid two">
      <div>
        <label>ìŠ¤ìº” ë²„íŠ¼ ì´ë¯¸ì§€ URL</label>
        <input id="cfgScanImg" placeholder="https://.../scan.png" />
      </div>
      <div>
        <label>ì˜¤ë‹µ ì²˜ë¦¬(ì½”ë“œ í‹€ë¦¼)</label>
        <div class="seg" id="wrongSeg">
          <button data-v="keep" class="active">ìœ ì§€</button>
          <button data-v="back1">í•œ ë‹¨ê³„ ë’¤ë¡œ</button>
          <button data-v="reset">1ë‹¨ê³„ë¡œ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>

    <div class="grid two">
      <div>
        <label>íƒœê·¸ ì‹¤íŒ¨ ì²˜ë¦¬(ë‹¤ë¥¸ ë‹¨ê³„ NFC)</label>
        <div class="seg" id="tagFailSeg">
          <button data-v="keep" class="active">ìœ ì§€</button>
          <button data-v="back1">í•œ ë‹¨ê³„ ë’¤ë¡œ</button>
          <button data-v="reset1">1ë‹¨ê³„ë¡œ</button>
        </div>
      </div>
      <div>
        <label>ì™„ë£Œ íŒì—… ì´ë¯¸ì§€ URL</label>
        <input id="cfgCompleteImg" placeholder="https://.../congrats.png" />
      </div>
    </div>

    <div class="grid two">
      <div>
        <label>í•¨ì • NFC</label>
        <div id="trapBox" class="grid"></div>
        <button class="small" id="btnAddTrap">í•¨ì • ì¶”ê°€</button>
      </div>
      <div>
        <label>ë§ˆì§€ë§‰ ì™„ë£Œ ë©”ì‹œì§€</label>
        <input id="cfgFinal" placeholder="ëª¨ë“  ë¯¸ì…˜ ì™„ë£Œ! êµì‹¤ë¡œ ë³µê·€í•˜ì„¸ìš”." />
      </div>
    </div>

    <hr/>
    <h4>íŒ€ êµ¬ì„±ê³¼ ë‹¨ê³„ ì„¤ì •</h4>
    <div class="grid two" style="margin-bottom:6px">
      <div>
        <label>íŒ€ ìˆ˜</label>
        <input id="cfgTeams" type="number" min="1" max="24" value="3" />
      </div>
      <div></div>
    </div>

    <div class="teamColsWrap"><div id="teamsBox" class="teamCols"></div></div>

    <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap">
      <button class="small" id="btnSave">ì €ì¥</button>
      <button class="small" id="btnShare">ì œì‘ ë§í¬ ë³µì‚¬</button>
      <button class="small" id="btnGen">íŒ€ë³„ ë§í¬ ìƒì„±</button>
    </div>
    <div class="urls" id="urlList" style="margin-top:8px"></div>
  </div>

  <script>
  /* ===================== ìœ í‹¸ ===================== */
  const el = (id)=>document.getElementById(id);
  const $ = (sel)=>document.querySelector(sel);

  const b64enc = (str)=>btoa(unescape(encodeURIComponent(str)));
  const b64dec = (b64)=>decodeURIComponent(escape(atob(b64)));

  const encodeCfg = (obj)=>b64enc(JSON.stringify(obj));
  const decodeCfg = (b64)=>JSON.parse(b64dec(b64));

  function getBase(){ const url = new URL(location.href); url.search=''; url.hash=''; return url.toString().replace(/#$/,''); }
  const teamParam = ()=>new URLSearchParams(location.search).get('team') || '';
  function hashCfg(){ const h=location.hash.replace(/^#/,''); const sp=new URLSearchParams(h); return sp.get('cfg')||''; }

  /* ===================== ë°ì´í„° êµ¬ì¡° ===================== */
  const DEFAULT_V24 = {
    title: 'NFC ë¯¸ì…˜',
    stages: 5,
    ui: { scanImg:'', completeImg:'' },
    wrongPolicy: 'keep',     // ì½”ë“œ ì˜¤ë‹µ: keep | back1 | reset
    nfcFailPolicy: 'keep',   // íƒœê·¸ ì‹¤íŒ¨: keep | back1 | reset1
    traps: [ /* { token:'TRAP1', mode:'reset1', message:'í•¨ì •ì…ë‹ˆë‹¤. 1ë‹¨ê³„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.' } */ ],
    finalMessage: 'ëª¨ë“  ë¯¸ì…˜ ì™„ë£Œ! êµì‹¤ë¡œ ë³µê·€í•˜ì„¸ìš”.',
    teams: [
      { name:'1íŒ€', slug:'t1', steps: Array.from({length:5}, ()=>({place:'', token:'', code:'', hint:'', hintImg:''})) },
      { name:'2íŒ€', slug:'t2', steps: Array.from({length:5}, ()=>({place:'', token:'', code:'', hint:'', hintImg:''})) },
      { name:'3íŒ€', slug:'t3', steps: Array.from({length:5}, ()=>({place:'', token:'', code:'', hint:'', hintImg:''})) }
    ]
  };

  function loadConfig(){
    const fromHash = hashCfg();
    if(fromHash){ try{ const cfg = decodeCfg(fromHash); localStorage.setItem('nfc-mission-v24:config', JSON.stringify(cfg)); return cfg; }catch(_){} }
    const raw = localStorage.getItem('nfc-mission-v24:config');
    return raw ? JSON.parse(raw) : structuredClone(DEFAULT_V24);
  }
  function saveConfig(){ localStorage.setItem('nfc-mission-v24:config', JSON.stringify(CONFIG)); }

  const currentTeam = ()=> CONFIG.teams.find(t=>t.slug===teamParam()) || null;
  const stateKey = ()=> `nfc-mission-v24:state:${currentTeam()?.slug || 'default'}`;
  function loadState(){ const raw=localStorage.getItem(stateKey()); return raw ? JSON.parse(raw) : { stage:1, lastHint:'', lastHintImg:'' }; }
  function saveState(){ localStorage.setItem(stateKey(), JSON.stringify(STATE)); }

  async function sha256(str){ const enc=new TextEncoder().encode(String(str)); const buf=await crypto.subtle.digest('SHA-256', enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''); }

  let CONFIG = loadConfig();
  let STATE = loadState();
  let ndef = null;
  let scanOK = false;
  let useCodeUI = false;

  /* ===================== íš¨ê³¼ìŒ ===================== */
  let ACTX = null;
  function playTone(seq){
    try{
      if(!ACTX) ACTX = new (window.AudioContext||window.webkitAudioContext)();
      const t0 = ACTX.currentTime + 0.01; let cur = t0;
      seq.forEach(s=>{
        const o = ACTX.createOscillator();
        const g = ACTX.createGain();
        o.type = s.type||'sine'; o.frequency.value = s.freq;
        g.gain.setValueAtTime(0.001, cur);
        g.gain.linearRampToValueAtTime((s.vol||0.2), cur+0.01);
        g.gain.exponentialRampToValueAtTime(0.001, cur + s.dur - 0.01);
        o.connect(g).connect(ACTX.destination);
        o.start(cur); o.stop(cur + s.dur);
        cur += s.dur + (s.gap||0);
      });
    }catch(e){}
  }
  const playOK  = ()=>playTone([{freq:880,dur:0.12,vol:0.25,type:'sine'},{freq:1320,dur:0.12,vol:0.25,type:'sine',gap:0.02}]);
  const playBad = ()=>playTone([{freq:330,dur:0.18,vol:0.25,type:'square'},{freq:220,dur:0.22,vol:0.25,type:'square',gap:0.02}]);

  /* ===================== ì´ˆê¸° ëª¨ë“œ ===================== */
  const IS_PLAY = !!teamParam();
  init();

  function init(){
    if(IS_PLAY){
      el('admin').classList.add('hidden');
      $('#gameScreen').classList.remove('hidden');

      const t = currentTeam();
      el('title').textContent = `ğŸ“ ${CONFIG.title}`;
      el('teamChip').textContent = t ? t.name : 'TEAM';
      renderStatusLine();
      applyScanImage();
      if(!('NDEFReader' in window)) setMsg('ì´ í™œë™ì€ NFC ì§€ì› ê¸°ê¸°ì—ì„œë§Œ ì§„í–‰ë©ë‹ˆë‹¤.', 'warn');
      el('btnScan').addEventListener('click', onScanClick);
      $('#btnHint').addEventListener('click', showHintPopup);
      if(STATE.stage>CONFIG.stages) setHint(CONFIG.finalMessage); 
      else if(STATE.lastHint) setHint(STATE.lastHint, STATE.lastHintImg);
      showScanUI();
    } else {
      $('#gameScreen').classList.add('hidden');
      el('admin').classList.remove('hidden');

      // ê¸°ë³¸ê°’ ì£¼ì…
      el('cfgTitle').value = CONFIG.title;
      el('cfgStages').value = CONFIG.stages;
      el('cfgScanImg').value = CONFIG.ui.scanImg||'';
      el('cfgCompleteImg').value = CONFIG.ui.completeImg||'';
      // ì„¸ê·¸ë¨¼íŠ¸
      updateSeg('wrongSeg', CONFIG.wrongPolicy||'keep', v=>CONFIG.wrongPolicy=v);
      updateSeg('tagFailSeg', CONFIG.nfcFailPolicy||'keep', v=>CONFIG.nfcFailPolicy=v);
      // í•¨ì • ë¦¬ìŠ¤íŠ¸
      renderTraps();
      // ì™„ë£Œ ë©”ì‹œì§€
      el('cfgFinal').value = CONFIG.finalMessage||'';
      // íŒ€ íŒ¨ë„
      renderTeamsPanel();

      // ì´ë²¤íŠ¸
      el('cfgStages').addEventListener('change', ()=>{ collectAdmin(); renderTeamsPanel(); });
      el('cfgTeams').addEventListener('change',  ()=>{ collectAdmin(); renderTeamsPanel(); });
      el('btnAddTrap').addEventListener('click', ()=>{ CONFIG.traps.push({token:'', mode:'reset1', message:'í•¨ì •ì…ë‹ˆë‹¤. 1ë‹¨ê³„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.'}); renderTraps(); });
      el('btnSave').addEventListener('click', ()=>{ collectAdmin(); saveConfig(); alert('ì €ì¥ ì™„ë£Œ'); });
      el('btnShare').addEventListener('click', ()=>{ collectAdmin(); const b64=encodeCfg(CONFIG); const base=getBase(); const url=`${base}#cfg=${b64}`; navigator.clipboard.writeText(url).then(()=>alert('ì œì‘ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ë§í¬ë¡œ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')); });
      el('btnGen').addEventListener('click', ()=>{ collectAdmin(); const base=getBase(); const b64=encodeCfg(CONFIG); const box=el('urlList'); box.innerHTML=''; CONFIG.teams.forEach(t=>{ const u=`${base}?team=${encodeURIComponent(t.slug)}#cfg=${b64}`; const s=document.createElement('span'); s.className='urltag'; s.textContent = `${t.name}: ${u}`; s.addEventListener('click', ()=>{ navigator.clipboard.writeText(u); alert(`${t.name} ë§í¬ ë³µì‚¬ë¨`); }); box.appendChild(s); }); });
    }
  }

  /* ===================== ë Œë” í•¨ìˆ˜ ===================== */
  function renderStatusLine(){ const total=CONFIG.stages; const cur=Math.min(STATE.stage,total); const done='âœ“'.repeat(Math.max(0,cur-1)); const left='â—‹'.repeat(Math.max(0,total-cur+1)); el('statusLine').textContent = `ì§„í–‰ ${cur}/${total} | ${done}${left}`; }
  function applyScanImage(){ const sURL=(CONFIG.ui.scanImg||'').trim(); const btn=el('btnScan'); if(sURL){ btn.classList.add('hasimg'); btn.innerHTML = `<img alt="scan" src="${sURL}">`; } else { btn.classList.remove('hasimg'); btn.textContent='ìŠ¤ìº” ì‹œì‘'; } }

  function showScanUI(){ useCodeUI=false; scanOK=false; const area=el('stageArea'); area.innerHTML=''; const btn=document.createElement('button'); btn.id='btnScan'; btn.className='big-btn'; btn.textContent='ìŠ¤ìº” ì‹œì‘'; const sURL=(CONFIG.ui.scanImg||'').trim(); if(sURL){ btn.classList.add('hasimg'); btn.innerHTML=`<img alt="scan" src="${sURL}">`; } area.appendChild(btn); btn.addEventListener('click', onScanClick); }
  function showCodeUI(){ useCodeUI=true; const area=el('stageArea'); area.innerHTML=''; const wrap=document.createElement('div'); wrap.className='code-area'; const p=document.createElement('div'); p.style.fontSize='15px'; p.textContent='ë¯¸ì…˜ì„ í†µí•´ íšë“í•œ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'; wrap.appendChild(p); const inp=document.createElement('input'); inp.id='codeInput'; inp.placeholder='ì˜ˆ: 5712'; inp.inputMode='numeric'; wrap.appendChild(inp); const btn=document.createElement('button'); btn.id='btnCode'; btn.className='code-btn'; btn.textContent='ì½”ë“œ ì œì¶œ'; wrap.appendChild(btn); area.appendChild(wrap); btn.addEventListener('click', onSubmitCode); }

  function updateSeg(id, val, onSet){ const seg=el(id); seg.querySelectorAll('button').forEach(b=>{ b.classList.toggle('active', b.dataset.v===val); b.onclick=()=>{ onSet(b.dataset.v); updateSeg(id, b.dataset.v, onSet); }; }); }

  function renderTraps(){ const box=el('trapBox'); box.innerHTML=''; if(!Array.isArray(CONFIG.traps)) CONFIG.traps=[]; CONFIG.traps.forEach((tr, i)=>{ const row=document.createElement('div'); row.className='trapRow'; row.innerHTML=`
      <div><label>NFC í…ìŠ¤íŠ¸</label><input data-i="${i}" data-k="token" placeholder="ì˜ˆ: TRAP1" value="${tr.token||''}"></div>
      <div><label>ë™ì‘</label><select data-i="${i}" data-k="mode"><option value="reset1">1ë‹¨ê³„ë¡œ</option><option value="back1">í•œ ë‹¨ê³„ ë’¤ë¡œ</option></select></div>
      <div><label>ë©”ì‹œì§€</label><input data-i="${i}" data-k="message" placeholder="í•¨ì •ì…ë‹ˆë‹¤. 1ë‹¨ê³„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤." value="${tr.message||''}"></div>
      <div><label>&nbsp;</label><button class="small" data-i="${i}" data-k="del">ì‚­ì œ</button></div>
    `; box.appendChild(row); row.querySelector(`select[data-i="${i}"][data-k="mode"]`).value = tr.mode||'reset1';
    // listeners
    row.querySelectorAll('input[data-i], select[data-i]').forEach(inp=>{ const k=inp.dataset.k; const idx=parseInt(inp.dataset.i,10); if(k==='del') return; inp.addEventListener('input', e=>{ CONFIG.traps[idx][k]=e.target.value; }); inp.addEventListener('change', e=>{ CONFIG.traps[idx][k]=e.target.value; }); });
    row.querySelector('button[data-k="del"]').addEventListener('click', ()=>{ CONFIG.traps.splice(i,1); renderTraps(); });
  }); }

  function ensureTeamShape(t){ while(t.steps.length < CONFIG.stages){ t.steps.push({place:'', token:'', code:'', hint:'', hintImg:''}); } if(t.steps.length > CONFIG.stages){ t.steps = t.steps.slice(0, CONFIG.stages); } }
  function makeTeam(n){ const steps=Array.from({length:CONFIG.stages}, ()=>({place:'', token:'', code:'', hint:'', hintImg:''})); return { name:`${n}íŒ€`, slug:`t${n}`, steps }; }

  function renderTeamsPanel(){
    // íŒ€ ìˆ˜ ë³´ì •
    let want=parseInt(el('cfgTeams').value||CONFIG.teams.length||1,10); if(isNaN(want)||want<1) want=1; if(want>24) want=24;
    if(!Array.isArray(CONFIG.teams)) CONFIG.teams=[];
    while(CONFIG.teams.length < want){ CONFIG.teams.push(makeTeam(CONFIG.teams.length+1)); }
    while(CONFIG.teams.length > want){ CONFIG.teams.pop(); }

    const box = el('teamsBox'); box.innerHTML='';
    CONFIG.teams.forEach((t,ti)=>{
      ensureTeamShape(t);
      const card = document.createElement('div'); card.className='teamCard';
      let rows='';
      rows += `<div class="stageHeader"><div>ë‹¨ê³„</div><div>ì¥ì†Œ</div><div>NFC í…ìŠ¤íŠ¸</div><div>ì½”ë“œ</div><div>ë‹¤ìŒ íŒíŠ¸</div></div>`;
      for(let i=0;i<CONFIG.stages;i++){
        const badge = `<div class="stageBadge">${i+1}ë‹¨ê³„</div>`;
        const place = `<input data-k="place" data-ti="${ti}" data-si="${i}" placeholder="ì˜ˆ: ê³¼í•™ì‹¤" value="${t.steps[i]?.place||''}">`;
        const token = `<input data-k="token" data-ti="${ti}" data-si="${i}" placeholder="ì˜ˆ: SCIENCE" value="${t.steps[i]?.token||''}">`;
        const code  = `<input data-k="code"  data-ti="${ti}" data-si="${i}" placeholder="ì˜ˆ: 5712" value="${t.steps[i]?.code||''}">`;
        const hint  = `
          <div class="grid" style="gap:6px">
            <input data-k="hint" data-ti="${ti}" data-si="${i}" placeholder="ì˜ˆ: ê³¼í•™ì‹¤ ì±…ì¥ ë’¤" value="${t.steps[i]?.hint||''}">
            <input data-k="hintImg" data-ti="${ti}" data-si="${i}" placeholder="íŒíŠ¸ ì´ë¯¸ì§€ URL(ì„ íƒ)" value="${t.steps[i]?.hintImg||''}">
          </div>`;
        rows += `<div class="stageRow5">${badge}<div>${place}</div><div>${token}</div><div>${code}</div><div>${hint}</div></div>`;
      }
      card.innerHTML = `
        <div class="grid two" style="margin-bottom:6px">
          <div><label>íŒ€ ì´ë¦„</label><input data-k="tname" data-ti="${ti}" value="${t.name}"></div>
          <div><label>URL ì‹ë³„ì</label><input data-k="slug" data-ti="${ti}" value="${t.slug}"></div>
        </div>
        <div class="grid">${rows}</div>
      `;
      box.appendChild(card);
      // listeners
      card.querySelector('input[data-k="tname"]').addEventListener('input', e=>{ t.name = e.target.value; });
      card.querySelector('input[data-k="slug"]').addEventListener('input', e=>{ t.slug = e.target.value; });
      card.querySelectorAll('input[data-k]').forEach(inp=>{ const k=inp.dataset.k; if(k==='tname'||k==='slug') return; inp.addEventListener('input', e=>{ const i=parseInt(e.target.dataset.si,10); t.steps[i] = t.steps[i]||{place:'',token:'',code:'',hint:'',hintImg:''}; t.steps[i][k]=e.target.value; }); });
    });
  }

  function collectAdmin(){
    CONFIG.title = (el('cfgTitle').value||'NFC ë¯¸ì…˜').trim();
    CONFIG.stages = Math.max(1, Math.min(20, parseInt(el('cfgStages').value||'5',10)));
    CONFIG.ui.scanImg = (el('cfgScanImg').value||'').trim();
    CONFIG.ui.completeImg = (el('cfgCompleteImg').value||'').trim();
    // ì„¸ê·¸ ê°’
    CONFIG.wrongPolicy = el('wrongSeg').querySelector('button.active')?.dataset.v || 'keep';
    CONFIG.nfcFailPolicy = el('tagFailSeg').querySelector('button.active')?.dataset.v || 'keep';
    // í•¨ì • DOMì—ì„œ ìˆ˜ì§‘
    const rows = el('trapBox').querySelectorAll('.trapRow');
    CONFIG.traps = Array.from(rows).map(r=>({
      token: r.querySelector('input[data-k="token"]').value.trim(),
      mode: r.querySelector('select[data-k="mode"]').value,
      message: r.querySelector('input[data-k="message"]').value.trim() || 'í•¨ì •ì…ë‹ˆë‹¤.'
    })).filter(x=>x.token);
    CONFIG.finalMessage = (el('cfgFinal').value||'ëª¨ë“  ë¯¸ì…˜ ì™„ë£Œ! êµì‹¤ë¡œ ë³µê·€í•˜ì„¸ìš”.').trim();
  }

  /* ===================== ìŠ¤ìº”/ì½”ë“œ ì²˜ë¦¬ ===================== */
  async function onScanClick(){
    if(!('NDEFReader' in window)) return setMsg('ì´ í™œë™ì€ NFC ì§€ì› ê¸°ê¸°ì—ì„œë§Œ ì§„í–‰ë©ë‹ˆë‹¤.', 'warn');
    try{
      if(!ndef) ndef = new NDEFReader();
      await ndef.scan();
      setMsg('ìŠ¤ìº” ëŒ€ê¸° ì¤‘â€¦ ìŠ¤í‹°ì»¤ì— ê°€ì ¸ë‹¤ ëŒ€ì„¸ìš”.','');
      ndef.onreading = (ev)=>{
        const text = extractText(ev.message.records);
        if(!text){ setMsg('ì¸ì‹ ì‹¤íŒ¨: í…ìŠ¤íŠ¸ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.','bad'); playBad(); return; }
        verifyToken(text.trim());
      };
    }catch(e){ setMsg('ìŠ¤ìº” ì‹œì‘ ì‹¤íŒ¨: '+ e.message, 'bad'); playBad(); }
  }
  function extractText(records){
    for(const r of records){
      try{
        if(r.recordType==='text'){ return new TextDecoder(r.encoding||'utf-8').decode(r.data); }
        if(r.recordType==='url'){  return new TextDecoder('utf-8').decode(r.data); }
      }catch{}
    } return '';
  }

  function verifyToken(token){
    const TK = String(token).toUpperCase();
    // 1) í•¨ì • ìš°ì„ 
    const trap = (CONFIG.traps||[]).find(tr=>String(tr.token).toUpperCase()===TK);
    if(trap){
      if(trap.mode==='reset1') STATE.stage=1; else STATE.stage=Math.max(1, STATE.stage-1);
      saveState(); renderStatusLine(); setHint(''); setMsg(trap.message||'í•¨ì •ì…ë‹ˆë‹¤.', 'bad'); playBad(); showScanUI(); return;
    }

    // 2) ì •ìƒ ë‹¨ê³„
    const t = currentTeam(); if(!t){ setMsg('ì„¤ì • ì˜¤ë¥˜: íŒ€ ë§í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.','bad'); playBad(); return; }
    const idx = Math.min(STATE.stage, CONFIG.stages)-1; const step = t.steps[idx]; if(!step){ setMsg('ì„¤ì • ì˜¤ë¥˜: ë‹¨ê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.','bad'); playBad(); return; }
    const expect = String(step.token||'').toUpperCase();
    if(TK === expect){ scanOK = true; setMsg('ìŠ¤ìº” ì„±ê³µ', 'ok'); playOK(); showCodeUI(); }
    else {
      setMsg('ì‹¤íŒ¨: ë‹¤ë¥¸ ë‹¨ê³„ì˜ NFC íƒœê·¸ì…ë‹ˆë‹¤.', 'bad'); playBad();
      const pol = CONFIG.nfcFailPolicy||'keep';
      if(pol==='reset1'){ STATE.stage=1; STATE.lastHint=''; STATE.lastHintImg=''; saveState(); renderStatusLine(); setHint('ì´ˆê¸°í™”ë¨. 1ë‹¨ê³„ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.'); }
      else if(pol==='back1'){ STATE.stage=Math.max(1, STATE.stage-1); saveState(); renderStatusLine(); setHint('í•œ ë‹¨ê³„ ë’¤ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.'); }
      showScanUI();
    }
  }

  async function onSubmitCode(){
    if(!scanOK) return setMsg('ë¨¼ì € ìŠ¤ìº”ì„ ì™„ë£Œí•˜ì„¸ìš”.','warn');
    const t = currentTeam(); const idx = Math.min(STATE.stage, CONFIG.stages)-1; const step = t.steps[idx];
    const input = (document.getElementById('codeInput').value||'').trim(); if(!input) return setMsg('ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.','warn');
    const ok = await sha256(String(step.code||'')) === await sha256(String(input));
    if(ok){
      const hint = step.hint||'';
      playOK();
      showResultPopup(true, 'ì •ë‹µ!', 'ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•˜ì„¸ìš”.');
      if(STATE.stage >= CONFIG.stages){
        STATE.stage = CONFIG.stages + 1;
        setHint(CONFIG.finalMessage);
        saveState(); renderStatusLine();
        showCompletePopup();
      } else {
        STATE.stage += 1;
        setHint(hint==='ë'? CONFIG.finalMessage : hint, step.hintImg||'');
        saveState(); renderStatusLine();
      }
      setMsg('ì •ë‹µ! ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•˜ì„¸ìš”.','ok');
      showScanUI();
    } else {
      setMsg('ì½”ë“œê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.','bad'); playBad();
      showResultPopup(false, 'ì‹¤íŒ¨!', 'ì½”ë“œë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.');
      const pol = (CONFIG.wrongPolicy||'keep');
      if(pol==='reset'){
        STATE.stage=1; STATE.lastHint=''; STATE.lastHintImg='';
        saveState(); renderStatusLine(); setHint('ì´ˆê¸°í™”ë¨. 1ë‹¨ê³„ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.');
        showScanUI();
      } else if(pol==='back1'){
        STATE.stage=Math.max(1, STATE.stage-1);
        saveState(); renderStatusLine(); setHint('í•œ ë‹¨ê³„ ë’¤ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.');
        showScanUI();
      }
    }
  }

  function setMsg(text, type){ const m=el('msg'); m.textContent=text; m.className='msg'; if(type) m.classList.add(type); }
  function setHint(text, img){
    const has = !!(text && text.trim().length);
    const btn = el('btnHint');
    btn.disabled = !has;
    STATE.lastHint = has ? text : '';
    STATE.lastHintImg = has ? (img||'') : '';
    saveState();
  }

  function showHintPopup(){
    const m = el('hintModal'); const img = el('hintImg'); const textEl = el('hintText');
    const txt = STATE.lastHint || 'íŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
    const src = STATE.lastHintImg || '';
    textEl.textContent = txt;
    if(src){ img.src = src; img.style.display='block'; } else { img.style.display='none'; }
    m.classList.remove('hidden');
    el('btnCloseHint').onclick = ()=> m.classList.add('hidden');
  }

  function showResultPopup(isOK, title, msg){
    const m = el('resultModal'); const inner = el('resultInner');
    el('resultIcon').textContent = isOK ? 'âœ…' : 'âŒ';
    el('resultTitle').textContent = title;
    el('resultMsg').textContent = msg || '';
    inner.classList.remove('success','fail');
    inner.classList.add(isOK ? 'success' : 'fail');
    m.classList.remove('hidden');
    el('btnCloseResult').onclick = ()=> m.classList.add('hidden');
  }

  function showCompletePopup(){
    try{
      const m = el('completeModal'); const img = el('completeImg'); const src = (CONFIG.ui.completeImg||'').trim();
      if(src){ img.src = src; img.style.display='block'; } else { img.style.display='none'; }
      m.classList.remove('hidden'); el('btnCloseModal').onclick = ()=> m.classList.add('hidden');
    }catch(e){}
  }
  </script>
</body>
</html>
